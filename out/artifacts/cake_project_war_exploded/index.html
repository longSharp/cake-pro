<!--
 * @Author: 龙朝敏
 * @Date: 2020-10-13 20:35:04
 * @LastEditTime: 2020-10-19 10:51:41
 * @LastEditors: Please set LastEditors
 * @Description: 网站的入口文件
 * @FilePath: \web\index.html
-->
<!DOCTYPE html><!-- 此标签不属于网页的内容. 它是一条指令，告诉浏览器编写页面所用的标记的版本。 -->
<html lang="zh-CN">
<!-- 存放网页上所有的内容和信息 -->

<head>
    <!-- 存储网页上给浏览器或是搜索引擎看的所有信息 -->
    <meta charset="UTF-8"><!-- meta标签被称为元数据，作用是专门告诉浏览器或是搜索引擎关于网页的一些基本数据 -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,minimal-ui:ios">
    <meta name="Author" content="龙朝敏"><!-- 网页作者 -->
    <meta name="Keywords" content=""><!-- 网页关键词 -->
    <meta name="Description" content=""><!-- 网页描述 -->
    <title>幸福西饼</title><!-- title标签之间存放的是网页的名字 -->
    <link rel="stylesheet" href="./css/nprogress.css">
    <link rel="stylesheet" href="./css/resetCss.css">
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_2132364_va5xlwuteg.css">
    <link rel="stylesheet" href="./css/index.css">
</head>

<body>
    <div id="contain">
        <header id="header">
            <nav class="nav">
                <div class="content">
                    <div class="nav-left">
                        <h1 class="logo">
                            <a href="#/">
                                <img src="./static/images/logo_big.png" alt="幸福西饼">
                            </a>
                        </h1>
                        <div class="area">
                            <div class="name">
                                <span class="iconfont icon-dingwei"></span>
                                <span class="conx">北京市</span>
                            </div>
                            <div class="point">
                                <div>
                                    <span class="text">切换城市</span>
                                    <div class="panel">
                                        <div class="search-city">
                                            <label for="search">搜索城市</label>
                                            <div class="search-box">
                                                <i class="iconfont icon-search"></i>
                                                <input type="text" id="search" placeholder="请输入城市名称">
                                                <ul></ul>
                                            </div>
                                        </div>
                                        <div class="hot-city">
                                            <div class="hot-title">热门城市</div>
                                            <div class="hot-cont">
                                                <ul>
                                                    <li>深圳市</li>
                                                    <li>广州市</li>
                                                    <li>上海市</li>
                                                    <li class="hot-active">北京市</li>
                                                    <li>天津市</li>
                                                    <li>重庆市</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="select-box">
                                            <h3>选择区域</h3>
                                            <div class="select-cont">
                                                <div class="provins">
                                                    <div>
                                                        <span data-provin="1">北京</span>
                                                        <i
                                                            class="iconfont icon-zelvxuanzefeiyongdaosanjiaoxingfandui"></i>
                                                    </div>
                                                    <ul>

                                                    </ul>
                                                </div>
                                                <div class="citys">
                                                    <div>
                                                        <span>北京市</span>
                                                        <i
                                                            class="iconfont icon-zelvxuanzefeiyongdaosanjiaoxingfandui"></i>
                                                    </div>
                                                    <ul></ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            温馨提示：若购买中更换收货城市，可能导致购物车内容均被清空！
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <ul class="nav-list">

                        </ul>
                    </div>
                    <div class="icon">
                        <span class="iconfont icon-search"></span>
                        <a href=""><span class="iconfont icon-gouwuche"></span></a>
                        <a href=""><span class="iconfont icon-yonghu"></span></a>
                    </div>
                </div>
                <div class="small-type">

                </div>
                <div class="search">
                    <div class="con">
                        <input type="text">
                        <span class="iconfont icon-search"></span>
                    </div>
                </div>
            </nav>
        </header>
        <div id="user"></div>
        <div id="main">

        </div>
        <footer id="footer"></footer>
    </div>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/nprogress.js"></script>
    <script src="./js/template-web.js"></script>
    <script src="./js/router.js"></script>
    <script id="navList" type="text/html">
        <li>
            <a href="#/goods/1">全部</a>
        </li>
        {{each data as value index}}
        <li data-type="{{value.id}}"><a href="#/goods/{{value.type_name.charCodeAt()}}/1">{{value.type_name}}</a></li>
        {{/each}}
        <li><a href="">团购预约</a></li>
        <li><a href="">关于我们</a></li>
        <li><a href="">开店咨询</a></li>
    </script>
    <script id="footerTemp" type="text/html">
        <div class="foo">
            <div class="f1">
                <div class="foo-list">
                    <ul>
                        <li><a href="">品牌动态</a></li>
                        <li><a href="">生产经营资质</a></li>
                        <li><a href="">企业合作</a></li>
                        <li><a href="">发票申请</a></li>
                        <li><a href="">平台规则</a></li>
                        <li><a href="">帮助服务</a></li>
                        <li><a href="">联系我们</a></li>
                    </ul>
                </div>
                <div class="contact">
                    <ul>
                        <li><a href="">
                            <span class="iconfont icon-dianhua"></span>
                            400-999-6666</a></li>
                        <li><a href="">WEIBO</a></li>
                        <li><a href="">WECHAT</a></li>
                        <li><a href="">京东商城</a></li>
                    </ul>
                </div>
            </div>
            <div class="copy">
                <ul class="record-txt">
                    <li>深圳市幸福商城科技股份有限公司</li>
                    <li>粤ICP备16039394号-6 </li>
                    <li>京公网安备44030702002399</li>
                    <li>公司地址：深圳市龙岗区坂田街道布龙339鸿生源工业园A座5楼</li>
                </ul>
                <div class="record-img">
                    <img src="./static/images/icon3.png" alt="">
                    <img src="./static/images/brand_bottom_large.jpg" alt="">
                </div>
            </div>
        </div>
    </script>
    <script id="provinal" type="text/html">
        {{each data value}}
            <li data-provin="{{value.pid}}">{{value.Provincial}}</li>
        {{/each}}
    </script>
    <script id="city" type="text/html">
        {{each data value}}
            <li>{{value.city}}</li>
        {{/each}}
    </script>
    <script id="fuzzyCity" type="text/html">
        {{each data value}}
            <li data-type="{{value.pid}}">{{value.city}}</li>
        {{/each}}
    </script>
    <script id="pages" type="text/html">
        <div class="pages-box">
            <ul>
                <li><</li>
                {{each data}}
                <li><a href="#/goods/{{$index+1}}">{{$index+1}}</a></li>
                {{/each}}
                <li>></li>
            </ul>
        </div>
    </script>
    <script>
        $(function () {
            var baseUrl = "http://localhost:8080/cake";

            /**
            * @description: 获取一个完整的url
            * @param url
            * @return url 完整url 
            */

            window.getUrl = function (url) {
                return baseUrl + url;
            }

            let NP = NProgress;
            /**
             * @description: 设置全局的ajax
             */
            $.ajaxSetup({
                beforeSend: function () {
                    NProgress.start();
                }
            });
            $(document).ajaxSuccess(function () {
                NProgress.done();
            });

            /**
            * @description: 为商品小类型盒子添加元素
            * @param data 数据  
            */
            function addEle(data) {
                var elements = "";
                for (let i = 0; i < data.length; i++) {
                    var ele = "<ul data-type=" + data[i].id + ">";
                    for (let j = 0; j < data[i].smallType.length; j++) {
                        var liEle = "<li><a href='#/goods/"+data[i].smallType[j].s_type_name.charCodeAt()+"/1' data-type=" + data[i].smallType[j].b_id + " data-typesmall=" + data[i].smallType[j].id + "><img src=" + data[i].smallType[j].type_img + ">" + "<br>" + "<span>" + data[i].smallType[j].s_type_name + "</span>" + "</a><li>";
                        ele += liEle;
                    }
                    ele += "</ul>";
                    elements += ele;
                }
                $(".small-type").append(elements);
            }

            /**
             * @description: 初始化网站首页数据
             */
            function init() {
                $.ajax({
                    url: getUrl("/goods/type"),
                    type: "GET",
                    success: function (data) {
                        data = JSON.parse(data);
                        var html = template("navList", { data: data });
                        $("#header .nav-list").html(html);
                        addEle(data);

                        $("#header .small-type ul li").click(function(){
                            var route = $(this).children("a").children("span").html().charCodeAt();
                            Router.route("/goods/"+route+"/1",function(){
                                
                            })
                        });
                        
                        var toggle = false;
                        $("#header .nav-list li").mouseover(function () {
                            if (!($("#header .search").is(".seach-active"))) {
                                var that = $(this);
                                if (that.attr("data-type")) {
                                    $("#header .small-type").addClass("type-active");
                                    $("#header .small-type ul").hide();
                                    $("#header .small-type ul").each(function () {
                                        if ($(this).attr("data-type") == that.attr("data-type")) {
                                            $(this).show();
                                            toggle = true;
                                        }
                                    });
                                }
                            }
                        }).mouseout(function () {
                            if (toggle) {
                                $("#header .small-type").removeClass("type-active");
                                $("#header .small-type").mouseover(function () {
                                    $(this).addClass("type-active");
                                }).mouseout(function () {
                                    $(this).removeClass("type-active");
                                });
                            }
                        });

                        var flag = true;
                        $("#header .icon .icon-search").click(function () {
                            if (flag) {
                                $("#header .nav div.search").addClass("seach-active");
                                flag = false;
                            } else {
                                $("#header .nav div.search").removeClass("seach-active");
                                flag = true;
                            }
                        });

                    }
                });

                $.ajax({
                    url: getUrl("/provin"),
                    type: "GET",
                    success: function (data) {
                        data = JSON.parse(data);
                        var p = template("provinal", { data: data });
                        $("#header .panel .select-box .select-cont>div:nth-child(1) ul").html(p);
                        $.ajax({
                            url: getUrl("/provin/city"),
                            type: "GET",
                            data: {
                                pid: $("#header .panel .select-box .select-cont>div:nth-child(1)>div>span").attr("data-provin")
                            },
                            success: function (cityData) {
                                cityData = JSON.parse(cityData);
                                var c = template("city", { data: cityData });
                                $("#header .panel .select-box .select-cont>div:nth-child(2)>div>span").html(cityData[0].city);
                                $("#header .panel .select-box .select-cont>div:nth-child(2) ul").html(c);
                                $(".select-cont>div:nth-child(2) li").on("click", function () {
                                    $(".select-cont>div:nth-child(2) div span").html($(this).html());
                                    $("#header .area>.name>span").html($(this).html());
                                    $(".panel").removeClass("panel-active");
                                })
                            }
                        });
                        $(".select-cont>div:nth-child(1) li").on("click", function () {
                            var t = $(this);
                            $.ajax({
                                url: getUrl("/provin/city"),
                                type: "GET",
                                data: {
                                    pid: t.attr("data-provin")
                                },
                                success: function (cityData) {
                                    cityData = JSON.parse(cityData);
                                    var c = template("city", { data: cityData });
                                    $("#header .panel .select-box .select-cont>div:nth-child(2)>div>span").html(cityData[0].city);
                                    $("#header .panel .select-box .select-cont>div:nth-child(2) ul").html(c);
                                    $("#header .panel .select-box .select-cont>div:nth-child(1)  div span").html(t.html());
                                    
                                    $(".select-cont>div:nth-child(2) li").on("click", function () {
                                    $(".select-cont>div:nth-child(2) div span").html($(this).html());
                                    $("#header .area>.name>span:nth-child(2)").html($(this).html());
                                    $(".panel").removeClass("panel-active");
                                })
                                }
                            });
                        })
                    }
                });

                $(".search-box input").on("input", function () {
                    var val = $(".search-box input").val();
                    val = val.replace(/\s/g, "");
                    if (val) {
                        $.ajax({
                            url: getUrl("/provin/fuzzy"),
                            type: "GET",
                            data: {
                                name: val
                            },
                            success: function (data) {
                                data = JSON.parse(data);
                                var fuz = template("fuzzyCity", { data: data });
                                if (data) {
                                    $('.search-box>ul').html(fuz).addClass("active");
                                }

                                $("#header .panel>.search-city .search-box>ul>li").on("click", function () {
                                    $(".panel").removeClass("panel-active");
                                    $("#header .area>.name>span:nth-child(2)").html($(this).html());
                                    $("#header .panel>.search-city .search-box input").val("");
                                    $(this).parent().html("").removeClass('active');
                                });


                            }
                        });
                    } else {
                        $('.search-box>ul').html("").removeClass("active");
                    }
                });


                $.get("./html/index_main.html", function (d) {
                    let render = template.compile(d);
                    let html = render();
                    $("#main").html(html);
                    $("body").css("display", "block");
                });

                var footerHtml = template("footerTemp", {});
                $("#footer").html(footerHtml);

                $("#header .area>.point>div>span").click(function () {
                    $("#header .area>.point .panel").toggleClass("panel-active");
                    $("#header .panel .select-box .select-cont>div").click(function () {
                        $(this).children("ul").toggleClass("active");
                    });
                    $("#header .panel .select-box .select-cont>div>ul").removeClass("active");
                });
            }

            //主页路由
            Router.route("/", function () {
                init();
            });

            /**
             * @description: 商品列表页函数
             * @param data 商品数据 
             * @param type_id 商品类型id
             */
            function goodsEn(data,b_id,s_id){
                $.get("./html/goods_list.html",function(d){
                            var render = template.compile(d);
                            var cake = render({data:data});
                            $("#main").html(cake);

                            $.ajax({
                                url:getUrl("/goods/count"),
                                type:"GET",
                                data:{
                                    b_id:b_id?b_id:0,
                                    s_id:s_id?s_id:0
                                },
                                success:function(data1){
                                    var data1 = parseInt(data1);
                                    data1 = Math.ceil(data1/40);
                                    var arr = new Array(data1);
                                    var page = template("pages",{data:arr});
                                    $("#main").append(page);

                                    $("#main .pages-box ul li").eq(1).addClass("active");
                                    $("#main .pages-box ul li").slice(1,data1+1).click(function(){
                                        var that = this;
                                        Router.route("/goods/"+$(that).children("a").html(),function(){
                                            if(!$(that).hasClass("active")){
                                            $("#main .pages-box ul li").removeClass("active");
                                            $(that).addClass("active");
                                            var index = (parseInt($(that).children("a").html())-1)*40;
                                            $.ajax({
                                                url:getUrl("/goods/list"),
                                                type:"GET",
                                                data:{
                                                    b_id:b_id?b_id:0,
                                                    s_id:0,
                                                    index:index,
                                                    limit:40
                                                },
                                                success:function(data2){
                                                    data2 = JSON.parse(data2);
                                                    $.get("./html/goods_list.html",function(d1){
                                                        var render = template.compile(d);
                                                        var ht = render({data:data2});
                                                        $("#goods_list").remove();
                                                        $("#main").prepend(ht);
                                                    })
                                                }
                                            });
                                        }
                                        });
                                    });
                                }
                            });
                        })
            }
            
            /**
             * @description: 商品大类型函数
             * @param b_id_index 大类型所在元素的下标 
             */
            function b_type(b_id_index){
                var b_id = $("#header .nav-list>li:nth-child("+b_id_index+")").attr("data-type");
                $.ajax({
                    url:getUrl("/goods/list"),
                    type:"GET",
                    data:{
                        b_id:b_id,
                        s_id:0,
                        index:0,
                        limit:40
                    },
                    success:function(data){
                        data = JSON.parse(data);
                        goodsEn(data,b_id,0);
                    }
                })
            }
            
            //全部商品路由
            Router.route("/goods/1",function(){
                $.ajax({
                    url:getUrl("/goods/list"),
                    data:{
                        b_id:0,
                        s_id:0,
                        index:0,
                        limit:40
                    },
                    type:"GET",
                    success:function(data){
                        data = JSON.parse(data);
                        goodsEn(data);
                    }
                });
            });

            //蛋糕类商品路由
            Router.route("/goods/"+"蛋糕".charCodeAt()+"/1",function(){
                b_type(2);
            })

            //下午茶类商品路由
            Router.route("/goods/"+"下午茶".charCodeAt()+"/1",function(){
                b_type(3);
            });

            //手信类商品路由
            Router.route("/goods/"+"手信".charCodeAt()+"/1",function(){
                b_type(4);
            });

        })
    </script>
</body>

</html>